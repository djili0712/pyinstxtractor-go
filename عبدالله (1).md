# -*- coding: utf-8 -*-
import tkinter as tk
from tkinter import ttk, messagebox
import json
import os
from datetime import datetime, timedelta
from PIL import Image, ImageTk
import calendar

class مدير_الاشتراكات_المحسن:
    def __init__(self, نافذة):
        self.نافذة = نافذة
        self.نافذة.title("🔄 مدير الاشتراكات - نظام متابعة الدفع")
        self.نافذة.geometry("1200x800")
        
        # جعل النافذة في المنتصف
        self.نافذة.eval('tk::PlaceWindow . center')
        
        # ملف حفظ البيانات
        self.ملف_البيانات = "اشتراكات_مدفوعة.json"
        
        # تحميل البيانات
        self.البيانات = self.تحميل_البيانات()
        
        # إعداد السمات والألوان
        self.إعداد_السمات()
        
        # إنشاء الواجهة
        self.إنشاء_الواجهة()
        self.تحديث_القائمة()

    def إعداد_السمات(self):
        """إعداد السمات والألوان للتطبيق"""
        self.ألوان = {
            'نشط': '#e8f5e8',
            'قريب': '#fff8e1', 
            'عاجل': '#fff3e0',
            'متأخر': '#ffebee',
            'تم_الدفع': '#f0f8ff',
            'رئيسي': '#2c3e50',
            'ثانوي': '#3498db'
        }

    def إنشاء_الواجهة(self):
        """إنشاء واجهة المستخدم مع تركيز على تاريخ الدفع"""
        # الإطار الرئيسي
        self.إطار_رئيسي = ttk.Frame(self.نافذة, padding=15)
        self.إطار_رئيسي.pack(fill="both", expand=True)
        
        # العنوان الرئيسي
        عنوان = ttk.Label(self.إطار_رئيسي, 
                         text="🔄 نظام متابعة اشتراكات الدفع", 
                         font=('Arial', 22, 'bold'),
                         foreground=self.ألوان['رئيسي'])
        عنوان.pack(pady=15)
        
        # إطار إدخال البيانات مع تركيز على تاريخ الدفع
        self.إنشاء_إطار_إدخال_الدفع()
        
        # إطار الإحصائيات المالية
        self.إنشاء_إطار_الإحصائيات_المالية()
        
        # إطار قائمة الاشتراكات
        self.إنشاء_إطار_قائمة_الاشتراكات()
        
        # إطار تقويم المدفوعات
        self.إنشاء_إطار_تقويم_المدفوعات()

    def إنشاء_إطار_إدخال_الدفع(self):
        """إنشاء إطار إدخال بيانات الدفع"""
        إطار_إدخال = ttk.LabelFrame(self.إطار_رئيسي, 
                                   text="💳 تسجيل بيانات الدفع الأساسية", 
                                   padding=20)
        إطار_إدخال.pack(fill="x", pady=15, padx=10)
        
        # صف 1: المعلومات الأساسية
        صف1 = ttk.Frame(إطار_إدخال)
        صف1.pack(fill="x", pady=8)
        
        ttk.Label(صف1, text="اسم الاشتراك *:", font=('Arial', 10, 'bold')).grid(row=0, column=0, sticky='w', padx=5)
        self.مدخل_الاسم = ttk.Entry(صف1, width=25, font=('Arial', 10))
        self.مدخل_الاسم.grid(row=0, column=1, padx=5)
        self.مدخل_الاسم.bind('<Return>', lambda e: self.مدخل_السعر.focus())
        
        ttk.Label(صف1, text="السعر الشهري *:", font=('Arial', 10, 'bold')).grid(row=0, column=2, sticky='w', padx=5)
        self.مدخل_السعر = ttk.Entry(صف1, width=15, font=('Arial', 10))
        self.مدخل_السعر.grid(row=0, column=3, padx=5)
        self.مدخل_السعر.bind('<Return>', lambda e: self.مدخل_تاريخ_الدفع.focus())
        
        # صف 2: تواريخ الدفع (الأساسية)
        صف2 = ttk.Frame(إطار_إدخال)
        صف2.pack(fill="x", pady=8)
        
        ttk.Label(صف2, text="تاريخ الدفع الأخير *:", font=('Arial', 10, 'bold')).grid(row=0, column=0, sticky='w', padx=5)
        self.مدخل_تاريخ_الدفع = ttk.Entry(صف2, width=15, font=('Arial', 10))
        self.مدخل_تاريخ_الدفع.grid(row=0, column=1, padx=5)
        self.مدخل_تاريخ_الدفع.insert(0, datetime.now().strftime('%Y-%m-%d'))
        
        ttk.Label(صف2, text="(YYYY-MM-DD)", font=('Arial', 8), foreground='gray').grid(row=0, column=2, sticky='w')
        
        ttk.Label(صف2, text="دورة الدفع:", font=('Arial', 10, 'bold')).grid(row=0, column=3, sticky='w', padx=5)
        self.قائمة_دورة_الدفع = ttk.Combobox(صف2, width=12, values=["شهري", "ربع سنوي", "نصف سنوي", "سنوي"], state="readonly")
        self.قائمة_دورة_الدفع.set("شهري")
        self.قائمة_دورة_الدفع.grid(row=0, column=4, padx=5)
        
        # صف 3: معلومات إضافية
        صف3 = ttk.Frame(إطار_إدخال)
        صف3.pack(fill="x", pady=8)
        
        ttk.Label(صف3, text="طريقة الدفع:", font=('Arial', 10, 'bold')).grid(row=0, column=0, sticky='w', padx=5)
        self.قائمة_طريقة_الدفع = ttk.Combobox(صف3, width=15, values=["بطاقة ائتمان", "تحويل بنكي", "PayPal", "نقدي", "أخرى"], state="readonly")
        self.قائمة_طريقة_الدفع.set("بطاقة ائتمان")
        self.قائمة_طريقة_الدفع.grid(row=0, column=1, padx=5)
        
        ttk.Label(صف3, text="الفئة:", font=('Arial', 10, 'bold')).grid(row=0, column=2, sticky='w', padx=5)
        self.قائمة_الفئة = ttk.Combobox(صف3, width=12, values=["ترفيه", "تعليم", "أعمال", "تسوق", "برامج", "أخرى"], state="readonly")
        self.قائمة_الفئة.set("ترفيه")
        self.قائمة_الفئة.grid(row=0, column=3, padx=5)
        
        # صف 4: الملاحظات
        صف4 = ttk.Frame(إطار_إدخال)
        صف4.pack(fill="x", pady=8)
        
        ttk.Label(صف4, text="ملاحظات الدفع:", font=('Arial', 10, 'bold')).grid(row=0, column=0, sticky='nw', padx=5)
        self.مدخل_الملاحظات = tk.Text(صف4, width=60, height=3, font=('Arial', 10))
        self.مدخل_الملاحظات.grid(row=0, column=1, columnspan=4, padx=5, sticky='ew')
        
        # أزرار التحكم
        self.إنشاء_أزرار_التحكم(إطار_إدخال)

    def إنشاء_أزرار_التحكم(self, parent):
        """إنشاء أزرار التحكم الخاصة بنظام الدفع"""
        إطار_أزرار = ttk.Frame(parent)
        إطار_أزرار.pack(pady=15)
        
        ttk.Button(إطار_أزرار, 
                  text="💳 تسجيل الدفع", 
                  command=self.تسجيل_دفع_جديد).pack(side=tk.LEFT, padx=8)
        
        ttk.Button(إطار_أزرار, 
                  text="✅ تأكيد الدفع", 
                  command=self.تأكيد_الدفع).pack(side=tk.LEFT, padx=8)
        
        ttk.Button(إطار_أزرار, 
                  text="✏️ تعديل الدفع", 
                  command=self.تعديل_دفع).pack(side=tk.LEFT, padx=8)
        
        ttk.Button(إطار_أزرار, 
                  text="📊 تقرير المدفوعات", 
                  command=self.عرض_تقرير_الدفع).pack(side=tk.LEFT, padx=8)
        
        ttk.Button(إطار_أزرار, 
                  text="🔄 تحديث", 
                  command=self.تحديث_القائمة).pack(side=tk.LEFT, padx=8)
        
        ttk.Button(إطار_أزرار,
                  text="🗑️ حذف مختار",
                  command=self.حذف_اشتراك).pack(side=tk.LEFT, padx=8)

    def إنشاء_إطار_الإحصائيات_المالية(self):
        """إنشاء إطار الإحصائيات المالية"""
        self.إطار_إحصائيات = ttk.LabelFrame(self.إطار_رئيسي, 
                                          text="💰 لوحة التحكم المالية", 
                                          padding=15)
        self.إطار_إحصائيات.pack(fill="x", pady=10, padx=10)
        
        # إطار للإحصائيات
        self.إطار_أرقام = ttk.Frame(self.إطار_إحصائيات)
        self.إطار_أرقام.pack(fill="x")
        
        # سيتم تحديث هذه العناصر في تحديث_الإحصائيات_المالية
        self.تحديث_الإحصائيات_المالية()

    def تحديث_الإحصائيات_المالية(self):
        """تحديث الإحصائيات المالية"""
        for widget in self.إطار_أرقام.winfo_children():
            widget.destroy()
            
        if not self.البيانات:
            ttk.Label(self.إطار_أرقام, text="لا توجد مدفوعات مسجلة", foreground="gray").pack(pady=10)
            return
        
        # حساب الإحصائيات المالية
        إحصائيات = self.حساب_الإحصائيات_المالية()
        
        # عرض الإحصائيات في شبكة
        الإحصائيات_المهمة = [
            ("إجمالي المدفوعات", f"{إحصائيات['إجمالي_المدفوعات']:.2f} $", "💰"),
            ("المستحق هذا الشهر", f"{إحصائيات['المستحق_هذا_الشهر']:.2f} $", "📅"),
            ("المتأخر في السداد", f"{إحصائيات['المتأخر_في_السداد']:.2f} $", "⚠️"),
            ("عدد الاشتراكات النشطة", f"{إحصائيات['عدد_النشطة']}", "✅"),
            ("المدفوعات القادمة (7 أيام)", f"{إحصائيات['مدفوعات_قادمة']}", "🔔")
        ]
        
        for i, (عنوان, قيمة, أيقونة) in enumerate(الإحصائيات_المهمة):
            إطار_إحصائية = ttk.Frame(self.إطار_أرقام, relief='ridge', borderwidth=1)
            إطار_إحصائية.grid(row=0, column=i, padx=8, pady=5, sticky='nsew')
            
            ttk.Label(إطار_إحصائية, text=أيقونة, font=('Arial', 14)).pack(pady=(5,0))
            ttk.Label(إطار_إحصائية, text=عنوان, font=('Arial', 9, 'bold'), foreground='gray').pack()
            ttk.Label(إطار_إحصائية, text=قيمة, font=('Arial', 12, 'bold'), foreground=self.ألوان['رئيسي']).pack(pady=(0,5))
        
        # جعل الأعمدة متساوية
        for i in range(len(الإحصائيات_المهمة)):
            self.إطار_أرقام.columnconfigure(i, weight=1)

    def إنشاء_إطار_قائمة_الاشتراكات(self):
        """إنشاء إطار قائمة الاشتراكات مع تفاصيل الدفع"""
        إطار_قائمة = ttk.LabelFrame(self.إطار_رئيسي, 
                                   text="📋 سجل المدفوعات والاشتراكات", 
                                   padding=15)
        إطار_قائمة.pack(fill="both", expand=True, pady=10, padx=10)
        
        # إنشاء الجدول مع أعمدة تركز على الدفع
        أعمدة = ('الاسم', 'السعر', 'تاريخ_الدفع', 'الدورة', 'الحالة', 'الأيام_المتبقية', 'طريقة_الدفع', 'المبلغ_المتبقي')
        self.جدول = ttk.Treeview(إطار_قائمة, columns=أعمدة, show='headings', height=12)
        
        # تعريف العناوين مع تركيز على الدفع
        عناوين = {
            'الاسم': {'text': 'اسم الاشتراك', 'width': 150},
            'السعر': {'text': 'المبلغ الشهري', 'width': 100},
            'تاريخ_الدفع': {'text': 'تاريخ الدفع القادم', 'width': 120},
            'الدورة': {'text': 'دورة الدفع', 'width': 90},
            'الحالة': {'text': 'حالة الدفع', 'width': 120},
            'الأيام_المتبقية': {'text': 'أيام متبقية', 'width': 90},
            'طريقة_الدفع': {'text': 'طريقة الدفع', 'width': 110},
            'المبلغ_المتبقي': {'text': 'المستحق', 'width': 90}
        }
        
        for col, config in عناوين.items():
            self.جدول.heading(col, text=config['text'])
            self.جدول.column(col, width=config['width'])
        
        # شريط التمرير
        شريط_تمرير = ttk.Scrollbar(إطار_قائمة, orient=tk.VERTICAL, command=self.جدول.yview)
        self.جدول.configure(yscrollcommand=شريط_تمرير.set)
        
        self.جدول.pack(side=tk.LEFT, fill="both", expand=True)
        شريط_تمرير.pack(side=tk.RIGHT, fill=tk.Y)
        
        # ربط الأحداث
        self.جدول.bind('<Double-1>', self.عرض_تفاصيل_الدفع)
        self.جدول.bind('<Button-3>', self.عرض_قائمة_السياق_الدفع)

    def إنشاء_إطار_تقويم_المدفوعات(self):
        """إنشاء إطار تقويم للمدفوعات القادمة"""
        إطار_تقويم = ttk.LabelFrame(self.إطار_رئيسي, 
                                   text="📅 تقويم المدفوعات القادمة", 
                                   padding=10)
        إطار_تقويم.pack(fill="x", pady=10, padx=10)
        
        # إطار للأسبوع الحالي
        إطار_أسبوعي = ttk.Frame(إطار_تقويم)
        إطار_أسبوعي.pack(fill="x", pady=5)
        
        ttk.Label(إطار_أسبوعي, text="المدفوعات في الأيام السبعة القادمة:", font=('Arial', 10, 'bold')).pack(anchor='w')
        
        self.قائمة_المدفوعات_القادمة = tk.Text(إطار_أسبوعي, height=4, font=('Arial', 9))
        self.قائمة_المدفوعات_القادمة.pack(fill="x", pady=5)
        
        # تحديث قائمة المدفوعات القادمة
        self.تحديث_المدفوعات_القادمة()

    def تحديث_المدفوعات_القادمة(self):
        """تحديث قائمة المدفوعات القادمة"""
        self.قائمة_المدفوعات_القادمة.delete('1.0', tk.END)
        
        اليوم = datetime.now()
        نهاية_الأسبوع = اليوم + timedelta(days=7)
        
        مدفوعات_قادمة = []
        for اشتراك in self.البيانات:
            try:
                تاريخ_دفع = datetime.strptime(اشتراك['تاريخ_الدفع'], '%Y-%m-%d')
                if اليوم <= تاريخ_دفع <= نهاية_الأسبوع:
                    أيام_متبقية = (تاريخ_دفع - اليوم).days
                    مدفوعات_قادمة.append((اشتراك['اسم'], اشتراك['سعر'], تاريخ_دفع, أيام_متبقية))
            except:
                continue
        
        if not مدفوعات_قادمة:
            self.قائمة_المدفوعات_القادمة.insert('1.0', "لا توجد مدفوعات في الأسبوع القادم 🎉")
            return
        
        # ترتيب المدفوعات حسب التاريخ
        مدفوعات_قادمة.sort(key=lambda x: x[2])
        
        for اسم, سعر, تاريخ, أيام in مدفوعات_قادمة:
            نص = f"📌 {اسم}: {سعر:.2f} $ - بعد {أيام} يوم (في {تاريخ.strftime('%Y-%m-%d')})\n"
            self.قائمة_المدفوعات_القادمة.insert(tk.END, نص)

    def تسجيل_دفع_جديد(self):
        """تسجيل دفعة جديدة مع التحقق من تاريخ الدفع"""
        # التحقق من البيانات الأساسية
        if not self.التحقق_من_بيانات_الدفع():
            return
        
        # جمع البيانات
        بيانات_الدفع = self.جمع_بيانات_الدفع()
        
        # حساب تاريخ الدفع القادم
        تاريخ_دفع_قادم = self.حساب_تاريخ_الدفع_القادم(بيانات_الدفع)
        بيانات_الدفع['تاريخ_الدفع'] = تاريخ_دفع_قادم.strftime('%Y-%m-%d')
        
        # إضافة الاشتراك
        self.البيانات.append(بيانات_الدفع)
        self.حفظ_البيانات()
        
        messagebox.showinfo("تم بنجاح", f"تم تسجيل دفعة '{بيانات_الدفع['اسم']}' بنجاح\nتاريخ الدفع القادم: {تاريخ_دفع_قادم.strftime('%Y-%m-%d')}")
        
        # مسح الحقول وتحديث الواجهة
        self.مسح_حقول_الدفع()
        self.تحديث_القائمة()

    def التحقق_من_بيانات_الدفع(self):
        """التحقق من صحة بيانات الدفع"""
        اسم = self.مدخل_الاسم.get().strip()
        سعر_نص = self.مدخل_السعر.get().strip()
        تاريخ_دفع = self.مدخل_تاريخ_الدفع.get().strip()
        
        if not اسم:
            messagebox.showerror("خطأ", "يرجى إدخال اسم الاشتراك")
            self.مدخل_الاسم.focus()
            return False
            
        if not سعر_نص:
            messagebox.showerror("خطأ", "يرجى إدخال سعر الاشتراك")
            self.مدخل_السعر.focus()
            return False
            
        try:
            سعر = float(سعر_نص)
            if سعر <= 0:
                raise ValueError("السعر يجب أن يكون موجباً")
        except ValueError:
            messagebox.showerror("خطأ", "يرجى إدخال سعر صحيح وموجب")
            self.مدخل_السعر.focus()
            return False
        
        if not تاريخ_دفع:
            messagebox.showerror("خطأ", "يرجى إدخال تاريخ الدفع")
            self.مدخل_تاريخ_الدفع.focus()
            return False
            
        try:
            datetime.strptime(تاريخ_دفع, '%Y-%m-%d')
        except ValueError:
            messagebox.showerror("خطأ", "صيغة التاريخ غير صحيحة\nاستخدم الصيغة: YYYY-MM-DD")
            self.مدخل_تاريخ_الدفع.focus()
            return False
        
        return True

    def جمع_بيانات_الدفع(self):
        """جمع بيانات الدفع من الحقول"""
        return {
            "اسم": self.مدخل_الاسم.get().strip(),
            "سعر": float(self.مدخل_السعر.get().strip()),
            "تاريخ_الدفع": self.مدخل_تاريخ_الدفع.get().strip(),
            "دورة_الدفع": self.قائمة_دورة_الدفع.get(),
            "طريقة_الدفع": self.قائمة_طريقة_الدفع.get(),
            "فئة": self.قائمة_الفئة.get(),
            "ملاحظات": self.مدخل_الملاحظات.get('1.0', tk.END).strip(),
            "تاريخ_التسجيل": datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            "حالة_الدفع": "نشط"
        }

    def حساب_تاريخ_الدفع_القادم(self, بيانات_الدفع):
        """حساب تاريخ الدفع القادم بناءً على دورة الدفع"""
        تاريخ_آخر_دفع = datetime.strptime(بيانات_الدفع['تاريخ_الدفع'], '%Y-%m-%d')
        دورة = بيانات_الدفع['دورة_الدفع']
        
        if دورة == "شهري":
            return تاريخ_آخر_دفع + timedelta(days=30)
        elif دورة == "ربع سنوي":
            return تاريخ_آخر_دفع + timedelta(days=90)
        elif دورة == "نصف سنوي":
            return تاريخ_آخر_دفع + timedelta(days=180)
        elif دورة == "سنوي":
            return تاريخ_آخر_دفع + timedelta(days=365)
        else:
            return تاريخ_آخر_دفع + timedelta(days=30)  # افتراضي

    def مسح_حقول_الدفع(self):
        """مسح حقول إدخال الدفع"""
        self.مدخل_الاسم.delete(0, tk.END)
        self.مدخل_السعر.delete(0, tk.END)
        self.مدخل_الملاحظات.delete('1.0', tk.END)
        self.مدخل_الاسم.focus()

    def تأكيد_الدفع(self):
        """تأكيد إجراء دفعة للاشتراك المحدد"""
        مختار = self.جدول.selection()
        if not مختار:
            messagebox.showwarning("تنبيه", "يرجى اختيار اشتراك لتأكيد الدفع")
            return
            
        فهرس = self.جدول.index(مختار[0])
        if 0 <= فهرس < len(self.البيانات):
            self.تسجيل_دفعة_جديدة(فهرس)

    def تسجيل_دفعة_جديدة(self, فهرس):
        """تسجيل دفعة جديدة للاشتراك المحدد"""
        اشتراك = self.البيانات[فهرس]
        
        # إنشاء نافذة تأكيد الدفع
        نافذة_دفع = tk.Toplevel(self.نافذة)
        نافذة_دفع.title("تأكيد عملية الدفع")
        نافذة_دفع.geometry("400x300")
        نافذة_دفع.transient(self.نافذة)
        نافذة_دفع.grab_set()
        
        ttk.Label(نافذة_دفع, text="💳 تأكيد عملية الدفع", font=('Arial', 16, 'bold')).pack(pady=15)
        
        إطار_دفع = ttk.Frame(نافذة_دفع, padding=20)
        إطار_دفع.pack(fill="both", expand=True)
        
        # عرض معلومات الاشتراك
        ttk.Label(إطار_دفع, text=f"الاشتراك: {اشتراك['اسم']}", font=('Arial', 12, 'bold')).pack(anchor='w', pady=5)
        ttk.Label(إطار_دفع, text=f"المبلغ: {اشتراك['سعر']:.2f} $", font=('Arial', 11)).pack(anchor='w', pady=2)
        ttk.Label(إطار_دفع, text=f"آخر دفع: {اشتراك['تاريخ_الدفع']}", font=('Arial', 11)).pack(anchor='w', pady=2)
        
        # حقل تاريخ الدفع الجديد
        إطار_تاريخ = ttk.Frame(إطار_دفع)
        إطار_تاريخ.pack(fill="x", pady=15)
        
        ttk.Label(إطار_تاريخ, text="تاريخ الدفع الجديد:", font=('Arial', 10, 'bold')).pack(side=tk.LEFT)
        مدخل_تاريخ_جديد = ttk.Entry(إطار_تاريخ, width=12, font=('Arial', 10))
        مدخل_تاريخ_جديد.insert(0, datetime.now().strftime('%Y-%m-%d'))
        مدخل_تاريخ_جديد.pack(side=tk.LEFT, padx=5)
        
        # حقل الملاحظات الإضافية
        ttk.Label(إطار_دفع, text="ملاحظات الدفع:", font=('Arial', 10, 'bold')).pack(anchor='w', pady=(10,5))
        مدخل_ملاحظات_دفع = tk.Text(إطار_دفع, width=40, height=4)
        مدخل_ملاحظات_دفع.pack(fill="x", pady=5)
        
        def تأكيد_الدفعة():
            تاريخ_جديد = مدخل_تاريخ_جديد.get().strip()
            ملاحظات = مدخل_ملاحظات_دفع.get('1.0', tk.END).strip()
            
            # التحقق من صحة التاريخ
            try:
                datetime.strptime(تاريخ_جديد, '%Y-%m-%d')
            except ValueError:
                messagebox.showerror("خطأ", "صيغة التاريخ غير صحيحة")
                return
            
            # تحديث تاريخ الدفع
            اشتراك['تاريخ_الدفع'] = تاريخ_جديد
            if ملاحظات:
                اشتراك['ملاحظات_دفع'] = اشتراك.get('ملاحظات_دفع', '') + f"\nدفعة في {datetime.now().strftime('%Y-%m-%d')}: {ملاحظات}"
            
            # تحديث البيانات
            self.حفظ_البيانات()
            self.تحديث_القائمة()
            نافذة_دفع.destroy()
            messagebox.showinfo("تم الدفع", f"تم تسجيل الدفعة لـ '{اشتراك['اسم']}' بنجاح")
        
        # أزرار التأكيد
        إطار_أزرار = ttk.Frame(إطار_دفع)
        إطار_أزرار.pack(pady=20)
        
        ttk.Button(إطار_أزرار, text="💳 تأكيد الدفع", command=تأكيد_الدفعة).pack(side=tk.LEFT, padx=10)
        ttk.Button(إطار_أزرار, text="❌ إلغاء", command=نافذة_دفع.destroy).pack(side=tk.LEFT, padx=10)

    def تعديل_دفع(self):
        """تعديل بيانات الدفع للاشتراك المحدد"""
        مختار = self.جدول.selection()
        if not مختار:
            messagebox.showwarning("تنبيه", "يرجى اختيار اشتراك للتعديل")
            return
            
        فهرس = self.جدول.index(مختار[0])
        if 0 <= فهرس < len(self.البيانات):
            self.تعديل_بيانات_الدفع(فهرس)

    def تعديل_بيانات_الدفع(self, فهرس):
        """تعديل بيانات الدفع للاشتراك"""
        اشتراك = self.البيانات[فهرس]
        
        نافذة_تعديل = tk.Toplevel(self.نافذة)
        نافذة_تعديل.title("تعديل بيانات الدفع")
        نافذة_تعديل.geometry("500x400")
        نافذة_تعديل.transient(self.نافذة)
        نافذة_تعديل.grab_set()
        
        ttk.Label(نافذة_تعديل, text="✏️ تعديل بيانات الدفع", font=('Arial', 16, 'bold')).pack(pady=15)
        
        إطار_تعديل = ttk.Frame(نافذة_تعديل, padding=20)
        إطار_تعديل.pack(fill="both", expand=True)
        
        # حقول التعديل
        الحقول = [
            ("اسم الاشتراك:", "مدخل_اسم", اشتراك['اسم'], 30),
            ("السعر الشهري:", "مدخل_سعر", str(اشتراك['سعر']), 15),
            ("تاريخ الدفع:", "مدخل_تاريخ", اشتراك['تاريخ_الدفع'], 15),
            ("دورة الدفع:", "قائمة_دورة", اشتراك['دورة_الدفع'], 12),
            ("طريقة الدفع:", "قائمة_طريقة", اشتراك['طريقة_الدفع'], 15),
            ("الفئة:", "قائمة_فئة", اشتراك['فئة'], 12)
        ]
        
        المتغيرات = {}
        for i, (تسمية, مفتاح, قيمة, عرض) in enumerate(الحقول):
            ttk.Label(إطار_تعديل, text=تسمية).grid(row=i, column=0, sticky='w', pady=8, padx=5)
            
            if 'قائمة' in مفتاح:
                if 'دورة' in مفتاح:
                    قيم = ["شهري", "ربع سنوي", "نصف سنوي", "سنوي"]
                elif 'طريقة' in مفتاح:
                    قيم = ["بطاقة ائتمان", "تحويل بنكي", "PayPal", "نقدي", "أخرى"]
                else:
                    قيم = ["ترفيه", "تعليم", "أعمال", "تسوق", "برامج", "أخرى"]
                
                متغير = ttk.Combobox(إطار_تعديل, width=عرض, values=قيم, state="readonly")
                متغير.set(قيمة)
            else:
                متغير = ttk.Entry(إطار_تعديل, width=عرض)
                متغير.insert(0, قيمة)
            
            متغير.grid(row=i, column=1, sticky='w', pady=8, padx=5)
            المتغيرات[مفتاح] = متغير
        
        # حقل الملاحظات
        ttk.Label(إطار_تعديل, text="ملاحظات:").grid(row=len(الحقول), column=0, sticky='nw', pady=8, padx=5)
        مدخل_ملاحظات = tk.Text(إطار_تعديل, width=40, height=6)
        مدخل_ملاحظات.insert('1.0', اشتراك.get('ملاحظات', ''))
        مدخل_ملاحظات.grid(row=len(الحقول), column=1, sticky='ew', pady=8, padx=5)
        
        def حفظ_التعديلات():
            # تحديث البيانات
            اشتراك['اسم'] = المتغيرات['مدخل_اسم'].get().strip()
            try:
                اشتراك['سعر'] = float(المتغيرات['مدخل_سعر'].get().strip())
            except ValueError:
                messagebox.showerror("خطأ", "السعر يجب أن يكون رقماً")
                return
            
            # التحقق من صحة التاريخ
            try:
                datetime.strptime(المتغيرات['مدخل_تاريخ'].get().strip(), '%Y-%m-%d')
            except ValueError:
                messagebox.showerror("خطأ", "صيغة التاريخ غير صحيحة")
                return
                
            اشتراك['تاريخ_الدفع'] = المتغيرات['مدخل_تاريخ'].get().strip()
            اشتراك['دورة_الدفع'] = المتغيرات['قائمة_دورة'].get()
            اشتراك['طريقة_الدفع'] = المتغيرات['قائمة_طريقة'].get()
            اشتراك['فئة'] = المتغيرات['قائمة_فئة'].get()
            اشتراك['ملاحظات'] = مدخل_ملاحظات.get('1.0', tk.END).strip()
            
            self.حفظ_البيانات()
            self.تحديث_القائمة()
            نافذة_تعديل.destroy()
            messagebox.showinfo("تم", "تم تعديل بيانات الدفع بنجاح")
        
        # أزرار الحفظ والإلغاء
        إطار_أزرار = ttk.Frame(إطار_تعديل)
        إطار_أزرار.grid(row=len(الحقول)+1, column=0, columnspan=2, pady=20)
        
        ttk.Button(إطار_أزرار, text="💾 حفظ التعديلات", command=حفظ_التعديلات).pack(side=tk.LEFT, padx=10)
        ttk.Button(إطار_أزرار, text="❌ إلغاء", command=نافذة_تعديل.destroy).pack(side=tk.LEFT, padx=10)

    def حساب_الإحصائيات_المالية(self):
        """حساب الإحصائيات المالية المتقدمة"""
        if not self.البيانات:
            return {
                'إجمالي_المدفوعات': 0,
                'المستحق_هذا_الشهر': 0,
                'المتأخر_في_السداد': 0,
                'عدد_النشطة': 0,
                'مدفوعات_قادمة': 0
            }
        
        اليوم = datetime.now()
        إجمالي_المدفوعات = 0
        المستحق_هذا_الشهر = 0
        المتأخر_في_السداد = 0
        عدد_النشطة = 0
        مدفوعات_قادمة = 0
        
        for اشتراك in self.البيانات:
            try:
                تاريخ_دفع = datetime.strptime(اشتراك['تاريخ_الدفع'], '%Y-%m-%d')
                سعر = اشتراك['سعر']
                
                # إجمالي المدفوعات (جميع الاشتراكات النشطة)
                إجمالي_المدفوعات += سعر
                
                # المستحق هذا الشهر
                if تاريخ_دفع.month == اليوم.month and تاريخ_دفع.year == اليوم.year:
                    المستحق_هذا_الشهر += سعر
                
                # المتأخر في السداد
                if تاريخ_دفع < اليوم:
                    المتأخر_في_السداد += سعر
                
                # الاشتراكات النشطة
                if تاريخ_دفع >= اليوم:
                    عدد_النشطة += 1
                
                # المدفوعات القادمة في 7 أيام
                if اليوم <= تاريخ_دفع <= (اليوم + timedelta(days=7)):
                    مدفوعات_قادمة += 1
                    
            except Exception as e:
                print(f"خطأ في حساب إحصائيات الاشتراك: {e}")
                continue
        
        return {
            'إجمالي_المدفوعات': إجمالي_المدفوعات,
            'المستحق_هذا_الشهر': المستحق_هذا_الشهر,
            'المتأخر_في_السداد': المتأخر_في_السداد,
            'عدد_النشطة': عدد_النشطة,
            'مدفوعات_قادمة': مدفوعات_قادمة
        }

    def تحديث_القائمة(self):
        """تحديث قائمة الاشتراكات مع معلومات الدفع"""
        # مسح البيانات القديمة
        for عنصر in self.جدول.get_children():
            self.جدول.delete(عنصر)
        
        # إضافة البيانات الجديدة
        for اشتراك in self.البيانات:
            self.إضافة_صف_دفع_إلى_الجدول(اشتراك)
        
        # تحديث الإحصائيات والمدفوعات القادمة
        self.تحديث_الإحصائيات_المالية()
        self.تحديث_المدفوعات_القادمة()

    def إضافة_صف_دفع_إلى_الجدول(self, اشتراك):
        """إضافة صف دفعة إلى الجدول"""
        try:
            تاريخ_دفع = datetime.strptime(اشتراك['تاريخ_الدفع'], '%Y-%m-%d')
            اليوم = datetime.now()
            أيام_متبقية = (تاريخ_دفع - اليوم).days
            
            if أيام_متبقية < 0:
                حالة = "🛑 متأخر"
                لون = "متأخر"
                مبلغ_مستحق = اشتراك['سعر']
            elif أيام_متبقية == 0:
                حالة = "⚠️ مستحق اليوم"
                لون = "عاجل"
                مبلغ_مستحق = اشتراك['سعر']
            elif أيام_متبقية <= 7:
                حالة = "🔶 قريب"
                لون = "قريب"
                مبلغ_مستحق = اشتراك['سعر']
            else:
                حالة = "✅ نشط"
                لون = "نشط"
                مبلغ_مستحق = 0.0
                
        except Exception as e:
            حالة = "❓ غير معروف"
            أيام_متبقية = "؟"
            لون = "نشط"
            مبلغ_مستحق = 0.0
        
        # إضافة الصف إلى الجدول
        self.جدول.insert('', 'end', 
                        values=(
                            اشتراك['اسم'],
                            f"{اشتراك['سعر']:.2f}",
                            اشتراك['تاريخ_الدفع'],
                            اشتراك['دورة_الدفع'],
                            حالة,
                            أيام_متبقية if isinstance(أيام_متبقية, int) else أيام_متبقية,
                            اشتراك['طريقة_الدفع'],
                            f"{مبلغ_مستحق:.2f}" if مبلغ_مستحق > 0 else "0.00"
                        ), 
                        tags=(لون,))
        
        # تكوين الألوان
        self.جدول.tag_configure('متأخر', background=self.ألوان['متأخر'], foreground='#c62828')
        self.جدول.tag_configure('عاجل', background=self.ألوان['عاجل'], foreground='#ef6c00')
        self.جدول.tag_configure('قريب', background=self.ألوان['قريب'], foreground='#f9a825')
        self.جدول.tag_configure('نشط', background=self.ألوان['نشط'], foreground='#2e7d32')

    def عرض_تفاصيل_الدفع(self, event=None):
        """عرض تفاصيل الدفع للاشتراك المحدد"""
        مختار = self.جدول.selection()
        if not مختار:
            return
            
        فهرس = self.جدول.index(مختار[0])
        if 0 <= فهرس < len(self.البيانات):
            اشتراك = self.البيانات[فهرس]
            
            # حساب الأيام المتبقية
            try:
                تاريخ_دفع = datetime.strptime(اشتراك['تاريخ_الدفع'], '%Y-%m-%d')
                أيام_متبقية = (تاريخ_دفع - datetime.now()).days
                if أيام_متبقية < 0:
                    حالة = "متأخر في السداد"
                elif أيام_متبقية == 0:
                    حالة = "مستحق اليوم"
                elif أيام_متبقية <= 7:
                    حالة = "قريب من الاستحقاق"
                else:
                    حالة = "نشط"
            except:
                أيام_متبقية = "غير معروف"
                حالة = "غير معروف"
            
            تفاصيل = f"""
💳 تفاصيل الدفع والاشتراك:

🆔 اسم الاشتراك: {اشتراك['اسم']}
💰 السعر الشهري: {اشتراك['سعر']:.2f} $
📅 تاريخ الدفع القادم: {اشتراك['تاريخ_الدفع']}
🔄 دورة الدفع: {اشتراك['دورة_الدفع']}
💳 طريقة الدفع: {اشتراك['طريقة_الدفع']}
📂 الفئة: {اشتراك['فئة']}
🎯 حالة الدفع: {حالة}
⏰ الأيام المتبقية: {أيام_متبقية if isinstance(أيام_متبقية, int) else أيام_متبقية} يوم
📅 تاريخ التسجيل: {اشتراك.get('تاريخ_التسجيل', 'غير معروف')}
📝 ملاحظات: {اشتراك.get('ملاحظات', 'لا توجد ملاحظات')}
            """
            
            messagebox.showinfo(f"تفاصيل الدفع - {اشتراك['اسم']}", تفاصيل.strip())

    def عرض_قائمة_السياق_الدفع(self, event):
        """عرض قائمة السياق الخاصة بالدفع"""
        مختار = self.جدول.identify_row(event.y)
        if not مختار:
            return
            
        self.جدول.selection_set(مختار)
        
        قائمة_السياق = tk.Menu(self.نافذة, tearoff=0)
        قائمة_السياق.add_command(label="عرض تفاصيل الدفع", command=self.عرض_تفاصيل_الدفع)
        قائمة_السياق.add_command(label="تأكيد الدفع", command=self.تأكيد_الدفع)
        قائمة_السياق.add_command(label="تعديل بيانات الدفع", command=self.تعديل_دفع)
        قائمة_السياق.add_separator()
        قائمة_السياق.add_command(label="حذف الاشتراك", command=self.حذف_اشتراك)
        
        قائمة_السياق.tk_popup(event.x_root, event.y_root)

    def حذف_اشتراك(self):
        """حذف اشتراك من السجل"""
        مختار = self.جدول.selection()
        if not مختار:
            messagebox.showwarning("تنبيه", "يرجى اختيار اشتراك للحذف")
            return
            
        فهرس = self.جدول.index(مختار[0])
        if 0 <= فهرس < len(self.البيانات):
            اسم = self.البيانات[فهرس]['اسم']
            if messagebox.askyesno("تأكيد الحذف", f"هل أنت متأكد من حذف اشتراك '{اسم}'؟"):
                del self.البيانات[فهرس]
                self.حفظ_البيانات()
                self.تحديث_القائمة()
                messagebox.showinfo("تم", f"تم حذف اشتراك '{اسم}' بنجاح")

    def عرض_تقرير_الدفع(self):
        """عرض تقرير مفصل عن المدفوعات"""
        if not self.البيانات:
            messagebox.showinfo("التقارير", "لا توجد مدفوعات مسجلة")
            return
            
        # حساب التقارير
        تقارير = self.حساب_تقارير_الدفع()
        
        # إنشاء نافذة التقارير
        نافذة_تقرير = tk.Toplevel(self.نافذة)
        نافذة_تقرير.title("📊 تقرير المدفوعات الشامل")
        نافذة_تقرير.geometry("700x600")
        
        # جعل النافذة في المنتصف
        نافذة_تقرير.transient(self.نافذة)
        نافذة_تقرير.grab_set()
        
        # إطار التمرير
        إطار_تمرير = ttk.Frame(نافذة_تقرير)
        إطار_تمرير.pack(fill="both", expand=True, padx=20, pady=20)
        
        canvas = tk.Canvas(إطار_تمرير)
        شريط_تمرير = ttk.Scrollbar(إطار_تمرير, orient="vertical", command=canvas.yview)
        إطار_قابل_للتمرير = ttk.Frame(canvas)
        
        إطار_قابل_للتمرير.bind("<Configure>", lambda e: canvas.configure(scrollregion=canvas.bbox("all")))
        canvas.create_window((0, 0), window=إطار_قابل_للتمرير, anchor="nw")
        canvas.configure(yscrollcommand=شريط_تمرير.set)
        
        canvas.pack(side="left", fill="both", expand=True)
        شريط_تمرير.pack(side="right", fill="y")
        
        # عرض التقارير
        ttk.Label(إطار_قابل_للتمرير, text="📊 تقرير المدفوعات الشامل", font=('Arial', 18, 'bold')).pack(pady=15)
        
        # الإحصائيات المالية
        self.عرض_قسم_تقرير(إطار_قابل_للتمرير, "💰 الإحصائيات المالية", تقارير['إحصائيات_مالية'])
        
        # تحليل الحالة
        self.عرض_قسم_تقرير(إطار_قابل_للتمرير, "🎯 تحليل حالة المدفوعات", تقارير['تحليل_الحالة'])
        
        # التوزيع حسب الفئة
        self.عرض_قسم_تقرير(إطار_قابل_للتمرير, "📂 التوزيع حسب الفئة", تقارير['توزيع_الفئات'])
        
        # المدفوعات المتأخرة
        if تقارير['مدفوعات_متأخرة']:
            self.عرض_قسم_تقرير(إطار_قابل_للتمرير, "🛑 المدفوعات المتأخرة", تقارير['مدفوعات_متأخرة'])

    def حساب_تقارير_الدفع(self):
        """حساب تقارير الدفع الشاملة"""
        اليوم = datetime.now()
        
        # الإحصائيات المالية
        إحصائيات = self.حساب_الإحصائيات_المالية()
        
        # تحليل الحالة
        حالات = {'نشط': 0, 'قريب': 0, 'عاجل': 0, 'متأخر': 0}
        for اشتراك in self.البيانات:
            try:
                تاريخ_دفع = datetime.strptime(اشتراك['تاريخ_الدفع'], '%Y-%m-%d')
                أيام_متبقية = (تاريخ_دفع - اليوم).days
                
                if أيام_متبقية < 0:
                    حالات['متأخر'] += 1
                elif أيام_متبقية == 0:
                    حالات['عاجل'] += 1
                elif أيام_متبقية <= 7:
                    حالات['قريب'] += 1
                else:
                    حالات['نشط'] += 1
            except:
                pass
        
        # التوزيع حسب الفئة
        توزيع_الفئات = {}
        for اشتراك in self.البيانات:
            فئة = اشتراك['فئة']
            توزيع_الفئات[فئة] = توزيع_الفئات.get(فئة, 0) + 1
        
        # المدفوعات المتأخرة
        مدفوعات_متأخرة = []
        for اشتراك in self.البيانات:
            try:
                تاريخ_دفع = datetime.strptime(اشتراك['تاريخ_الدفع'], '%Y-%m-%d')
                if تاريخ_دفع < اليوم:
                    أيام_تأخر = (اليوم - تاريخ_دفع).days
                    مدفوعات_متأخرة.append(f"{اشتراك['اسم']}: {أيام_تأخر} يوم ({اشتراك['سعر']:.2f} $)")
            except:
                pass
        
        return {
            'إحصائيات_مالية': [
                f"إجمالي الاشتراكات: {len(self.البيانات)}",
                f"إجمالي المدفوعات الشهرية: {إحصائيات['إجمالي_المدفوعات']:.2f} $",
                f"المستحق هذا الشهر: {إحصائيات['المستحق_هذا_الشهر']:.2f} $",
                f"المتأخر في السداد: {إحصائيات['المتأخر_في_السداد']:.2f} $",
                f"التكلفة السنوية: {إحصائيات['إجمالي_المدفوعات'] * 12:.2f} $"
            ],
            'تحليل_الحالة': [
                f"✅ نشط: {حالات['نشط']}",
                f"🔶 قريب: {حالات['قريب']}",
                f"⚠️ عاجل: {حالات['عاجل']}",
                f"🛑 متأخر: {حالات['متأخر']}"
            ],
            'توزيع_الفئات': [f"{فئة}: {عدد}" for فئة, عدد in توزيع_الفئات.items()],
            'مدفوعات_متأخرة': مدفوعات_متأخرة
        }

    def عرض_قسم_تقرير(self, parent, عنوان, محتويات):
        """عرض قسم في التقرير"""
        إطار_قسم = ttk.LabelFrame(parent, text=عنوان, padding=12)
        إطار_قسم.pack(fill="x", pady=10)
        
        for محتوى in محتويات:
            ttk.Label(إطار_قسم, text=محتوى, font=('Arial', 10)).pack(anchor='w', pady=3)

    def تحميل_البيانات(self):
        """تحميل البيانات من الملف"""
        if os.path.exists(self.ملف_البيانات):
            try:
                with open(self.ملف_البيانات, 'r', encoding='utf-8') as ملف:
                    return json.load(ملف)
            except Exception as e:
                messagebox.showerror("خطأ", f"خطأ في تحميل البيانات: {e}")
                return []
        else:
            # بيانات تجريبية تركز على الدفع
            return [
                {
                    "اسم": "نيتفليكس",
                    "سعر": 45,
                    "تاريخ_الدفع": (datetime.now() + timedelta(days=5)).strftime('%Y-%m-%d'),
                    "دورة_الدفع": "شهري",
                    "طريقة_الدفع": "بطاقة ائتمان",
                    "فئة": "ترفيه",
                    "ملاحظات": "باقة بريميوم - تجديد تلقائي",
                    "تاريخ_التسجيل": datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                    "حالة_الدفع": "نشط"
                },
                {
                    "اسم": "يوتيوب بريميوم",
                    "سعر": 35,
                    "تاريخ_الدفع": (datetime.now() + timedelta(days=12)).strftime('%Y-%m-%d'),
                    "دورة_الدفع": "شهري",
                    "طريقة_الدفع": "PayPal",
                    "فئة": "ترفيه",
                    "ملاحظات": "موسيقى بدون إعلانات",
                    "تاريخ_التسجيل": datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                    "حالة_الدفع": "نشط"
                }
            ]

    def حفظ_البيانات(self):
        """حفظ البيانات في الملف"""
        try:
            with open(self.ملف_البيانات, 'w', encoding='utf-8') as ملف:
                json.dump(self.البيانات, ملف, ensure_ascii=False, indent=2)
        except Exception as e:
            messagebox.showerror("خطأ", f"خطأ في حفظ البيانات: {e}")

if __name__ == "__main__":
    try:
        # إعداد النافذة الرئيسية
        نافذة_رئيسية = tk.Tk()
        
        # تحسين مظهر التطبيق ليتناسب مع Windows
        نمط = ttk.Style()
        نمط.theme_use('vista')  # استخدام سمة Vista التي تأتي مع Windows
        
        # جعل التطبيق يظهر في شريط المهام
        نافذة_رئيسية.iconbitmap(default='')  # يمكن إضافة أيقونة هنا إذا رغبت
        
        تطبيق = مدير_الاشتراكات_المحسن(نافذة_رئيسية)
        
        # إضافة اختصار لوحة المفاتيح (Ctrl+Q للإغلاق)
        نافذة_رئيسية.bind('<Control-q>', lambda e: نافذة_رئيسية.quit())
        
        # تشغيل التطبيق
        نافذة_رئيسية.mainloop()
        
    except Exception as e:
        print(f"حدث خطأ: {e}")
        messagebox.showerror("خطأ تشغيل", f"حدث خطأ أثناء تشغيل التطبيق: {e}")
